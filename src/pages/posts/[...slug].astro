---
import { getCollection, getEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";

const { slug } = Astro.params;
let posts, entry, Content, remarkPluginFrontmatter, author;
if (slug === undefined) {
  posts = await getCollection("posts", (post) => {
    return post.data.draft !== true;
  });
} else {
  entry = await getEntry("posts", slug);
  if (entry === undefined) {
    return Astro.redirect("/404");
  }
  ({ Content, remarkPluginFrontmatter } = await entry.render());
  author = await getEntry(entry.data.author);
}
---

{
  slug ? (
    <BaseLayout title={entry.data.title}>
      <article>
        <h1 class="text-5xl mb-5 text-center">{entry.data.title}</h1>
        <p class="text-center mb-1">
          by{" "}
          <a class="link link-primary" href={`/author/${author.data.name}`}>
            {author.data.name}
          </a>{" "}
          on {entry.data.date}
        </p>
        <p class="text-center mb-1">{remarkPluginFrontmatter.minutesRead}</p>
        <Content />
      </article>
    </BaseLayout>
  ) : (
    <BaseLayout tytle="Posts">
      <ul>
        {posts.map((post) => (
          <li>
            <a href={`/posts/${post.slug}`}>{post.data.title}</a> -{" "}
            <a href={`/authors/${post.data.author.name}`}>{post.data.author}</a>{" "}
            - {post.data.date}
          </li>
        ))}
      </ul>
    </BaseLayout>
  )
}
